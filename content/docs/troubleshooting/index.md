---
title: 'Поиск и устранение неисправностей'
weight: 60
toc: true
---

> **Самые частые проблемы:**
> *   Не открываются заблокированные сайты на одном из устройств, хотя на других всё работает? Проверьте **[настройки DNS на этом устройстве](#диагностика-на-клиентском-устройстве-пк-смартфон)**.
> *   В диагностике ошибка `FakeIP Status: ! does not work in browser`? Скорее всего, дело в **[DNS на устройстве](#диагностика-на-клиентском-устройстве-пк-смартфон)** или **[«Безопасном DNS» в браузере](/docs/client-dns/)**.

## Принципы работы маршрутизации в Podkop

Маршрутизация `Podkop` **по доменным именам** работает корректно только при соблюдении всех следующих условий:

1.  **DNS-запросы** от клиентского устройства и его программ (браузер, приложения) направляются на роутер с `Podkop`.
2.  **Роутер с `Podkop`** является **шлюзом** для всего трафика клиентского устройства (или как минимум для подсети FakeIP `198.18.0.0/15`).
3.  **`dnsmasq` на роутере** обрабатывает все DNS-запросы и настроен на их пересылку на `127.0.0.42`. Эту опцию `Podkop` включает автоматически, если не активирована настройка [«Не трогать мой DHCP»](/docs/dont-touch-my-dhcp/).
4.  **Служба `sing-box`** запущена на роутере, прослушивает сокет `127.0.0.42:53`, её конфигурационный файл собран корректно, а удаленные списки доменов (.srs) загружены.
5.  **Правила `nftables`** активны, корректно маркируют транзитный трафик из локальной сети и перенаправляют его через `tproxy` на сокет `127.0.0.1:1602`.
6.  **Внешнее подключение** (прокси-ссылка, Outbound-конфигурация или VPN-интерфейс) полностью работоспособно, и у роутера есть доступ в интернет.

## Ключевые выводы для диагностики

*   Если на одних устройствах в сети всё работает, а на других — нет, проблема почти всегда кроется в **локальных настройках** этих устройств. Либо они используют сторонние DNS-серверы, либо их трафик идёт не через роутер с `Podkop` (например, из-за активного VPN-клиента). См. раздел [«DNS на устройствах»](/docs/client-dns/).
*   Тесты на вкладке `Диагностика` корректно работают **только из локальной сети**. Не стоит анализировать их результаты, если вы подключены к веб-интерфейсу роутера удалённо (например, через проброс портов) — они будут показывать ошибки, даже если всё в порядке.

## Быстрый обзор: вкладка «Диагностика»

> ℹ️ **Важно:** В LuCI OpenWrt используется агрессивный механизм кэширования. Если вы недавно обновляли `Podkop`, первым делом [очистите кэш браузера](/docs/clear-browser-cache/) или откройте вкладку «Диагностика» в приватном окне.

Проверяйте статусы в таблице последовательно. Если вы видите ошибку, решайте проблему на этом шаге, прежде чем двигаться дальше.

| Проверка | Статус | Что это означает и что делать |
| :--- | :--- | :--- |
| **Podkop Status** | ✔ `Autostart enabled` | Всё хорошо, служба будет запускаться после перезагрузки роутера. |
| | ✘ `Autostart disabled`| Автозапуск выключен. При перезагрузке роутера вы рискуете остаться без интернета. Включите автозапуск. |
| | ✘ `error` | Ошибка при получении статуса. Если она постоянна, сообщите в чат Podkop, сопроводив информацией, на какой системе, в каком браузере это происходит, приложите логи `Podkop` |
| **Sing-box Status** | ✔ `running` | Всё хорошо, процесс `sing-box` запущен. |
| | ✘ `stopped & disabled`| Процесс `sing-box` не запущен. Все последующие ошибки — следствие этой проблемы. Необходимо выяснить причину остановки. |
| | ✘ `error` | Ошибка при получении статуса. Если она постоянна, сообщите в чат Podkop, сопроводив информацией, на какой системе, в каком браузере это происходит, приложите логи `Podkop` |
| **FakeIP Status на роутере** | ✔ `works on router` | Всё хорошо, `sing-box` на роутере корректно отвечает FakeIP-адресом. |
| | ✘ `does not work on router`| Ответ на DNS-запрос не получен (вероятно, `sing-box` не работает) либо не является FakeIP (запросы перехватывает другая DNS-служба). |
| | ! `check error` | Редкая ошибка запуска `nslookup` на роутере из браузера. |
| **FakeIP Status в браузере** | ✔ `works in browser` | Всё хорошо, HTTPS-запрос к диагностическому домену прошел через `sing-box`. |
| | ! `does not work in browser`| **Самая частая ошибка.** Браузер не использует DNS роутера. Решение: [«DNS на устройствах»](/docs/client-dns/). |
| | ! `check error` | Запрос из браузера не удался. FakeIP-адрес получен, но трафик не доходит до `sing-box`. Проверьте, является ли роутер шлюзом для устройства, и нет ли ошибок в правилах `nftables`. |
| **Config** | ✔ `working` | Туннель работает. Запросы к диагностическим доменам вернули разные IP-адреса. |
| | ✘ `same IP for both domains`| Если FakeIP Status `! does not work in browser`, то работоспособность туннеля проверить нельзя, сначала устраните ошибку DNS.<br>Если же FakeIP Status `✔ works in browser`, то либо клиентское устройство добавлено в Принудительные прокси, либо VPN на роутере заворачивает все запросы в туннель |
| | ! `timeout` | Нет ответа от туннеля. Вероятнее всего, проблема с VPN-сервером или конфигурацией подключения. |
| | ! `check error` | Ошибка при ответе одного из диагностических доменов. Почти всегда означает ошибку в конфигурации туннеля. |

## Диагностика на клиентском устройстве (ПК, смартфон)

### Windows, macOS, Linux — открываем терминал для ввода команд

1.  **Проверка получения FakeIP:**

    ```shell
    nslookup fakeip.podkop.fyi
    ```
    
    Ожидаемый результат (адрес из диапазона `198.18.0.0/15`):
    ```text
    Server:		192.168.1.1
    Address:	192.168.1.1#53

    Name:	fakeip.podkop.fyi
    Address: 198.18.x.x
    ```

    *   **Если в ответе другой IP** (например, `64.188.104.86` вместо `198.18.x.x`), значит, ваше устройство использует сторонний DNS (его адрес в можно увидеть в строке Server). Решение — в статье [«DNS на клиентах»](/docs/client-dns/).
    *   **Если ответ пустой**, а в качестве сервера указан IP роутера, проблема на стороне роутера. Переходите к разделу [«Проверка настроек DNS на роутере»](#проверка-настроек-dns-на-роутере).

2.  **Проверка прохождения трафика через `sing-box`:**

    ```shell
    curl -v https://fakeip.podkop.fyi/check
    ```

    В выводе вы должны увидеть попытку подключения к FakeIP-адресу (`Trying 198.18.x.x...`) и в конце получить ответ:
    ```json
    {"fakeip": true, "IP": "XX.XX.XX.XX"}
    ```

    *   **Если `curl` «зависает»** и не может подключиться, значит, трафик не доходит до `sing-box`. Убедитесь, что роутер с `Podkop` является шлюзом для вашего устройства,
а [правила nftables работают](#проверка-правил-маркировки-и-проксирования-трафика)
    *   **Если `curl` подключается через адрес `198.18.*.*`, но в ответе `"fakeip": false`**, это указывает на серьёзную проблему в работе `sing-box` или правил `nftables`.

> **А если в терминале всё хорошо, а в браузере нет?**
> Если `nslookup` и `curl` в терминале работают правильно, а в «Диагностике» браузера всё равно ошибка `! does not work in browser`, откройте ссылку `https://fakeip.podkop.fyi/check` прямо в браузере. Если она вернет `{"fakeip": false, ...}`, значит, у вас включен [«Безопасный DNS» в браузере](/docs/client-dns/), который нужно отключить.

### Телевизоры, телефоны и умные устройства без терминала

Если на устройстве есть браузер с поддержкой JavaScript, откройте в нём веб-интерфейс Podkop (LuCI &#8594; Services &#8594; Podkop) и перейдите на вкладку «Диагностика». Этой информации, как правило, достаточно для понимания проблемы.

Если браузера нет, отследить DNS-запросы помогут [логи dnsmasq](/docs/dnsmasqlogs/), а увидеть, какой трафик идёт через роутер, — утилита `tcpdump`. Логика та же: если вы не видите DNS-запросов от устройства к `dnsmasq`, значит, на устройстве настроены внешние DNS-серверы или DoH (DNS over HTTPS).

## Проверка настроек DNS на роутере

Откройте SSH-консоль роутера.

1.  **Проверка, какие службы прослушивают порты:**

    ```shell
    netstat -tanp | grep LISTEN
    ```
    
    Ожидаемый результат должен содержать следующие строки:
    ```text
    tcp  ...  127.0.0.42:53    0.0.0.0:*   LISTEN   30933/sing-box
    tcp  ...  127.0.0.1:1602   0.0.0.0:*   LISTEN   30933/sing-box
    tcp  ...  127.0.0.1:53     0.0.0.0:*   LISTEN   31296/dnsmasq
    tcp  ...  192.168.1.1:53   0.0.0.0:*   LISTEN   31296/dnsmasq
    ```

    Это подтверждает, что `dnsmasq` принимает DNS-запросы на LAN-интерфейсе, а `sing-box` — на `127.0.0.42`. Если это не так, проверьте конфигурации `dnsmasq` или `sing-box`.

2.  **Проверка конфигурации `dnsmasq`:**

    ```shell
    uci show dhcp.@dnsmasq[0]
    ```

    В выводе должны присутствовать эти две строки:
    ```text
    dhcp.cfg01411c.noresolv='1'
    dhcp.cfg01411c.server='127.0.0.42'
    ```

    *   `noresolv='1'` — эта опция запрещает роутеру использовать внешние DNS-серверы (например, от провайдера), которые могут работать в обход `Podkop`.
    *   `server='127.0.0.42'` — эта опция гарантирует, что все DNS-запросы пересылаются напрямую в `sing-box`.
    
    Если этих настроек нет, или в списке `server` есть другие адреса, вероятно, у вас включена опция [«Не трогать мой DHCP»](/docs/dont-touch-my-dhcp/). Убедитесь, что вы настроили её правильно.

## Проверка правил маркировки и проксирования трафика

В SSH-консоли роутера выполните:

```shell
nft list ruleset | grep -B3 mark
```
Вы должны увидеть цепочки правил `mangle`, `mangle_output` и `proxy`, созданные `Podkop`. Ключевые моменты для проверки:

*   **Счетчики пакетов (`counter packets`)** в правилах для `ip daddr 198.18.0.0/15` в цепочке `mangle` должны быть **ненулевыми**. Если там нули, значит, трафик от клиентских устройств до роутера не доходит (проблема с DNS или шлюзом на клиенте).
*   **Нет других правил с маркировкой**. «Лишние» цепочки с правилами маркировки могут говорить о наличи конфликтующих пакетов
(например, неудалённый [GetDomains](https://github.com/itdoginfo/domain-routing-openwrt), упомянутый выше `vpn-client` на прошивках GL.iNet и т.п.)
*   **Сумма пакетов** в цепочках `mangle` и `mangle_output` должна примерно соответствовать счетчикам в цепочке `proxy`.
Существенно меньшее количество пакетов в `proxy` также указывает на конфликты правил `nftables` или о «простоях» `sing-box` (когда трафик шёл, а `sing-box` был недоступен)

## Проверка работоспособности VPN-интерфейса

Универсальный способ проверки для WireGuard, Amnezia WG или OpenVPN — команда `curl` в консоли роутера с указанием интерфейса:

```shell
# Замените wg0 на имя вашего интерфейса
curl -v --interface wg0 ifconfig.me
```

Если туннель работает, команда вернёт внешний IP-адрес вашего VPN-сервера. Если команда «зависает» или выдаёт ошибку, значит, проблема в самом туннеле.

## Проверка работоспособности прокси

Совместимость `Podkop` со всеми существующими прокси-клиентами и серверами гарантировать невозможно.

*   Если ваша ссылка работает в другом клиенте (например, NekoBox для Android), но не в `Podkop`, попробуйте экспортировать конфигурацию из NekoBox в формате JSON и вставить её как `Outbound Configuration` в `Podkop`.
*   Если это не помогает, протестируйте `Podkop` с 2-3 заведомо рабочими ссылками из [Community Sub](https://t.me/itdogchat/309009/435295). Если с ними всё работает, а с вашей — нет, проблема в вашей ссылке или в конфигурации вашего сервера.
*   В `Podkop` пока поддерживаются только vless:// и ss:// ссылки. Если вы уверены, что ваша ссылка рабочая (проверили в NekoBox), сгенерируйте временную строку для тестов и отправьте её на email: podkop@itdog.info

## Глобальная проверка и обращение за помощью

Большая часть описанных выше шагов автоматизирована в инструменте `Глобальная проверка` | `Global check`, который находится во вкладке `Диагностика` | `Diagnostics`. Он покажет вам все ключевые настройки и статусы системы.

Если вы не смогли самостоятельно определить и устранить проблему, приходите за помощью в [топик Podkop в Telegram-чате ITDog](https://t.me/itdogchat/81758/).

При обращении, пожалуйста, **обязательно** предоставьте следующую информацию, чтобы вам могли помочь быстрее:

1.  **Описание проблемы:** Что именно не работает, на каком устройстве, и как должно работать по-вашему.
2.  **Результаты самостоятельной проверки:** Кратко опишите, что вы уже проверили по этой инструкции и какие результаты получили (например, «nslookup выдает правильный FakeIP, а curl зависает»).
3.  **Вывод «Глобальной проверки»:** Приложите полный текстовый вывод, полученный после нажатия на кнопку `Global check`.
