---
title: 'Диагностика'
weight: 5
toc: true
---

Если у вас ничего или какая-то часть не работает, то вы по адресу.

## Самостоятельное решение проблем

В первую очередь после настройки перейдите во вкладку **Диагностика | Diagnostics**.

![diagnostics-example](images/luci-diagnostics-example.jpg)

Начиная с версии **0.7** диагностика не запускается автоматически, при переходе на вкладку.

Чтобы выполнить диагностику необходимо нажать кнопку **Запустить диагностику**.

В случае, если все проверки прошли успешно вы увидите следующее:

![diagnostics-example](images/luci-diagnostics-run.jpg)

 Здесь на скриншоте всё зелёное, а значит скорее всего, всё ок. 

Помните, при обновлении всегда нужно [чистить кэш](/docs/clear-browser-cache/).

Диагностика включает в себя следующие разделы:

## Проверки

###  DNS проверки
---
#### Основной DNS 
Отображает тип DNS и адрес. Если имеет красный цвет, то выбранный DNS у вас не работает. Пробуйте другой.

#### DNS на роутере
Говорит о работе DNS на самом роутере. Если имеет красный цвет, вы поломали DNS на роутере.

#### DHCP содержит DNS сервер
Проверяет что в **dnsmasq** указан сервер 127.0.0.42 для отправки DNS-запросов в `sing-box`. 

### Sing-box проверки
---

#### Sing-box установлен
Проверяет установлен ли `sing-box` на устройстве.

#### Версия sing-box >= 1.12.4
Проверяет версию установленного `sing-box`. В более старых версиях `sing-box` менялся конфиг, поэтому `podkop` может не работать. 

#### Сервис sing-box существует
Проверяет наличие файла **sing-box** в /etc/init.d/. 

#### Автостарт sing-box отключен
`podkop` управляет работой `sing-box`, поэтому автостарт для него должен быть отключен. 

#### Процесс sing-box запущен
Если статус "не запущен", это означает, что вы неправильно настроили `podkop` и `sing-box` не смог стартовать. 

#### Sing-box слушает порты
Означает что порты необходимые для работы `sing-box` свободны и прослушиваются.

### Nftables проверки
---

#### Таблица существует
Проверяет что таблица **PodkopTable** создана.
#### Правила mangle существуют
Проверяет наличие цепочки **mangle** в таблице **PodkopTable**
#### Счётчики правил mangle
Проверяем что трафик направляется через правила цепочки **mangle**.
#### Правила mangle output существуют
Проверяет наличие цепочки **mangle_output** в таблице **PodkopTable**
#### Счётчики правил mangle output
Проверяем что трафик направляется через правила цепочки **mangle_output**.
#### Правила прокси существуют
Проверяет наличие цепочки **proxy** в таблице **PodkopTable**
#### Счётчики правил proxy
Проверяем что трафик направляется через правила цепочки **proxy**.
#### Другие правила маркировки не найдены
Проверяет что не созданы другие правила nftables, мешающие работе `podkop`.

### Outbounds проверки
---

Отображает задержку до указанных в секциях туннелей. В случае использования **URLTest(Самый быстрый)** будет отображаться задержка всех рабочих прокси. Если прокси не отвечает вы получите ошибку.

### FakeIP проверки
---

#### DNS роутера проходит через sing-box
Проверяет что `sing-box` на роутере корректно отвечает FakeIP-адресом.
Ошибка здесь говорит о том, что DNS-запрос не получен, вероятно, `sing-box` не работает, либо запросы перехватывает другая DNS-служба.

#### Браузер использует FakeIP
Проверяет что HTTPS запрос к диагностическому домену прошел через `sing-box`.
Ошибка означает что браузер не использует DNS роутера. В случае ошибки обратитьесь к статье [DNS на устройствах](/docs/client-dns)

#### Прокси-трафик направляется через FakeIP
Туннель работает. Запросы к диагностическим доменам вернули разные IP-адреса. Если присутствует ошибка в проверке **Браузер использует FakeIP**, то работоспособность туннеля проверить нельзя, сначала устраните ошибку DNS. Если ошибка в правиле выше отсутствует, то либо клиентское устройство добавлено в опцию **Полностью маршрутизированные IP-адреса** в настройках секции, либо VPN на устройстве заворачивает все запросы в туннель.

## Доступные действия

| Имя действия                       | Описание                                                                                                                    |
|:-----------------------------------|:----------------------------------------------------------------------------------------------------------------------------|
| **Перезапустить Podkop**           | Перезапускает службу `podkop`                                                                                               |
| **Остановить Podkop**              | Останавливает `podkop`. В случае если автостарт не отключен, при перезагрузке `podkop` запустится.                          |
| **Отключить автостарт**            | Отключает автостарт `podkop` при перезагрузке устройства.                                                                   |
| **Получить глобальную проверку**   | **Global check**. Пригодится вам, если вы не сможете самостоятельно решить проблему и захотите обратиться в чат за помощью. |
| **Посмотреть логи**                | Отображает логи работы `podkop` и `sing-box`.                                                                               |
| **Показать sing-box конфигурацию** | Отображает текущую конфигурацию `sing-box`.                                                                                 |

## Системная информация

| Имя            | Описание                                 |
|:---------------|:-----------------------------------------|
| **Podkop**     | Установленная версия `podkop`            |
| **Luci App**   | Установленная версия `luci-app-podkop`   |
| **Sing-box**   | Установленная версия `sing-box`          |
| **OS OpenWRT** | Версия используемой на роутере `OpenWRT` |
| **Device**     | Модель вашего устройства                 |

## Не работает на одном из устройств

Если у вас не работает на опредленном устройстве, скорее всего, дело в DoH. Внимательно изучите эту [инструкцию](/docs/client-dns/)

Последний пункт, который может вам помочь - это **Global Check**. Если вы не понимаете вывод, переходите к следующему абзацу.

Если у вас не работает диагностика в LuCi или вы не используете LuCi, Global Check можно вызвать через командную строку:
```
/usr/bin/podkop global_check
```

## Данный раздел не помог решить проблему
Если вам не удалось решить проблему самостоятельно, воспользуйтесь кнопкой **Перейти в wiki** справа, которая ведет на страницу [Поиск и устранение неисправностей](/docs/troubleshooting) в которой описаны наиболее часто возникающие проблемы.

## Помощь зала

**Официальный чат** Podkop`a https://t.me/itdogchat/81758. Рекомендуем именно в нём спрашивать всё про Podkop. В нём сидят разработчики и просто умные люди, понимающие в OpenWrt и схеме FakeIP. В других чатах вы можете столкнуться с дичью и дилетанством.

Если вы не осилили самостоятельно решить проблему и выполнили все пункты:
- Проверили DNS на устройствах
- Попробовали с заведомо рабочими VLESS из **Community sub**
- На ваших клиентах запрос ```nslookup fakeip.podkop.fyi``` отдаёт IP-адрес из подсети **198.18.0.0/15**

Скидывайте вывод **Global check** в чат ТЕКСТОМ. Он сразу отформатирован под код, не убирайте кавычки. Также допишите, что вы пробовали, что именно не работает и все ли пункты выше у вас выполнены.
